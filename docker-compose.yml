services:
  server_tls:
    build: ./server_tls
    hostname: server_tls
    container_name: server_tls
    volumes:
      - ./pki_files/server_tls:/etc/nginx/certs:rw
    networks:
      pki-net:
        ipv4_address: 172.20.0.3

  server_mtls:
    build: ./server_mtls
    hostname: server_mtls
    container_name: server_mtls
    volumes:
     - ./pki_files/server_mtls/:/etc/easy-rsa/pki/:rw
    networks:
      pki-net:
        ipv4_address: 172.20.0.4

  client:
    build: ./client
    hostname: client
    container_name: client
    environment:
      - SSLKEYLOGFILE=/keylog/sslkeylog.log
    volumes:
      - ./pki_files/server_tls/server_tls_ecc.crt:/root/server_tls_ecc.crt:ro
      - ./pki_files/server_tls/server_tls_ecc.key:/root/server_tls_ecc.key:ro
      - ./pki_files/server_mtls/ca.crt:/root/ca.crt:ro
      - ./pki_files/server_mtls/issued/client.crt:/root/client.crt:ro
      - ./pki_files/server_mtls/private/client.key:/root/client.key:ro
      - ./keylog:/keylog:rw
    networks:
      pki-net:
        ipv4_address: 172.20.0.2
    # Next two settings keep container running, necessary for Wireshark capture
    stdin_open: true
    tty: true
    
networks:
  pki-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
